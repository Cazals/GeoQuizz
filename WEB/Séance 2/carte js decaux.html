<!doctype html>
<html>
<head>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAWSNSLXM2qISM2-RM01pGghDRFOK6LdLI"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.slim.min.js"></script>


<script>

var geocoder = new google.maps.Geocoder();
var carte;
var Creation;


//------------------------------------------------------------------
// récupérer ma position courante, afficher la carte et afficher un point correspondant sur ma carte
// ------------------------------------------------------------------
function callbackSucces(donnees) {
    // je récupere le résultat de l'appel webservices
    console.log(donnees);

    var JSONTab = JSON.parse(donnees);

    var obj;

    for(var i=0;i<JSONTab.length;i++){
        obj = JSONTab[i];
        console.log(obj.run + '-' + obj.status);
    }
}






function lireVelos(){

    // appel web service type post
    $.ajax({
        url: "https://api.jcdecaux.com/vls/v1/stations?contract=Toulouse&apiKey=90866e021aaa6ed8790cd89b85864c9ab5dbfed3",
        type: "GET",
        dataType: "json", // optionnel : format que je souhaite en réponse. si pas le cas je partirai en erreur!
        success: callbackSucces, // fonction de callback
        error: function(JSONstring) {
            console.log("Erreur Ajax :" + JSONstring);
        }
    });


}


/*
var JSONstring=
    '[{"run":"2012121118","day":"20121212","status":"complete"},{"run":"2012121106","day":"20121212","status":"complete"},{"run":"2012121018","day":"20121211","status":"complete"},{"run":"2012121006","day":"20121211","status":"complete"},{"run":"2012120918","day":"20121210","status":"complete"},{"run":"2012120906","day":"20121210","status":"complete"}]';

var JSONTab = JSON.parse(JSONstring);

var obj;

for(var i=0;i<JSONTab.length;i++){
    obj = JSONTab[i];
    console.log(obj.run + '-' + obj.status);
}*/





// callbacks de la fonction getCurrentPosition() 
function callback_geo_ok(objet) {
	var latitude = objet.coords.latitude;
	var longitude = objet.coords.longitude;
	affichercarte(latitude,longitude); // j'affiche la carte avec un marqueur sur ma position


}
function callback_geo_error(objet) {
	alert(objet.message+" / "+objet.code);	 
}


// demander au navigateur ma position 
function recuperer_maposition() {
	if(navigator.geolocation){
	
		navigator.geolocation.getCurrentPosition(
			callback_geo_ok,
			callback_geo_error, 
			{ enableHighAccuracy:true, maximumAge:5000, timeout:5000}
		);
		
		// Ici j'affiche la carte et le point
		
		
	} else {
		alert('Erreur : pas de support de la géolocalisation dans votre navigateur');
	}
}



//------------------------------------------------------------------
// demander le décodage d'une adresse en point coordonnées et 
// placement d'un marqueur sur la carte

function decoder_adresse() {
	var adresse = document.getElementById("txtAdresse").value;
	geocoder.geocode( {'address': adresse}, callback_decoder);
}


function callback_decoder(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
     	// j'ajoute le marqueur de l'adresse saisie
		ajouterMarqueur(results[0].geometry.location.lat(), results[0].geometry.location.lng());
		
      } else {
			alert("Erreur Geocode: " + status);
      }
}



// -----------------------------------
// fonctions qui gerent l'affichage d'une carte (fait une fois au début)
// et l'ajout des marqueurs

function ajouterMarqueur(latitude,longitude) {

	// je créé le marqueur
	var point = new google.maps.LatLng(latitude,longitude)
	var marker = new google.maps.Marker(
	 { 
		position: point, 
		title:''
	});
	
	// je place le marqueur sur la carte
	marker.setMap(carte);
	
	// je centre la carte sur ce nouveau marqueur
	carte.panTo(point);


}


function affichercarte(latitude, longitude) {
	
	
	console.log("(affichemap)latitude,longitude"+latitude+" - "+longitude);
	//objet contenant des propriétés avec des identificateurs prédéfinis dans Google Maps permettant
	//de définir des options d'affichage de notre carte
	var options = {
		center: new google.maps.LatLng(latitude,longitude),
		zoom: 13,
		mapTypeId: 'roadmap'
	};
	 
	//constructeur de la carte qui prend en paramêtre le conteneur HTML
	//dans lequel la carte doit s'afficher et les options
	carte = new google.maps.Map(document.getElementById("divcarte"), options);
	
	ajouterMarqueur(latitude,longitude); // j'ajoute le marqueur de ma position courante.
			
}


</script>
</head>


<body>



<input type="text" id="txtAdresse" value="" />
<input type="button" onclick="decoder_adresse();" value="placer marqueur" />

<div id="divcarte" style="width:500px;height:500px"></div>


<script>
    creation=1;




	recuperer_maposition();

    lireVelos();

	//setInterval(recuperer_maposition,3000);
</script>

</body>
</html>





